#!/bin/sh
bin=/home/m/Programming/mkchromecast/bin/mkchromecast
res=$(xdpyinfo | awk '/dimensions/{print $2}')
choice=$(printf "Local Video\\nDesktop\\nYouTube\\nSource URL" | dmenu -i -p "Choose mode")

gettime() { \
	echo "$( printf "" | dmenu -p "Specify the timestamp" )"
}

ifsub() { \
	echo "$(printf "No\\nYes" | dmenu -i -p "Use subtitles?" )"
}

subtitles(){ \
	subtitles="$(find ~/Videos | grep .srt | dmenu -i -l 10 )"
	# fix="$(echo $subtitles | sed 's/\]/\\]/g' | sed 's/\[/\\[/g' )"
	ffmpeg -y  -i "$subtitles" -ss "$1" /tmp/fixedsubs.srt  &&
	echo "/tmp/fixedsubs.srt"

}

pickvideo(){ \
	echo "$(find ~/Videos -maxdepth 5 | grep -e ".mp4\|.mkv\|.wmv\|mov\|avi" | \
		dmenu -i -l 10 -p "Choose video to stream")"
}

case $choice in
	Desktop) $TERMINAL "$bin" --hijack --video -s --screencast --resolution "$res" ;;
	YouTube) $TERMINAL "$bin" --hijack --control --video -s -y "$(xclip -o)" ;;
	Source\ URL) $TERMINAL "$bin" --hijack --control --video -s --source-url "$(xclip -o)" ;;
	Local\ Video) video=$(pickvideo)
		if [ "$(ifsub)" = "No" ]; then
			$TERMINAL "$bin" --hijack --control --video -s --seek "$(gettime)" -i "$video"
		else
			time="$(gettime)"
			$TERMINAL "$bin" --hijack --control --video -s --seek "$time" \
				-i "$video" --subtitles "$(subtitles "$time")"
		fi ;;
esac
